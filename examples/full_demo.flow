-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- FlowLang Full Demo Project: Notes API Server
-- Demonstrates all std modules: web, json, file, path, url, time, timer,
-- crypto, os, math, string, array, color, stream
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

circle web from "std:web"
circle json from "std:json"
circle fs from "std:file"
circle path from "std:path"
circle url from "std:url"
circle time from "std:time"
circle timer from "std:timer"
circle crypto from "std:crypto"
circle os from "std:os"
circle color from "std:color"
circle stream from "std:stream"
circle arr from "std:array"

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Type Definitions using sigil keyword
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

sigil Note {
    id: Silk,
    title: Silk,
    content: Silk,
    createdAt: Silk,
    hash: Silk
}

sigil ServerConfig {
    port: Ember,
    dataFile: Silk
}

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Configuration & Data
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let PORT: Ember = 3000
let DATA_FILE: Silk = "notes.json"
let requestCount: Ember = 0
let startTime: Ember = time.timestamp()
let notes: Constellation<Silk> = []

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Utility Functions using std modules
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Generate unique ID using crypto
cast Spell generateId() -> Silk {
    let timestamp: Ember = time.timestamp()
    let hash: Silk = crypto.md5(timestamp + "-" + requestCount)
    return hash
}

-- Load notes from file using std:file
cast Spell loadNotes() -> Hollow {
    in Stance (fs.exists(DATA_FILE)) {
        attempt {
            let content: Silk = fs.read(DATA_FILE)
            notes = json.parse(content)
            shout(color.green("âœ“ Loaded " + notes.len() + " notes from disk"))
        } rescue Rift as e {
            shout(color.yellow("âš  Could not load notes: " + e))
            notes = []
        }
    }
}

-- Save notes to file using std:file and std:json
cast Spell saveNotes() -> Hollow {
    attempt {
        let content: Silk = json.stringify(notes)
        fs.write(DATA_FILE, content)
    } rescue Rift as e {
        shout(color.red("âœ— Failed to save: " + e))
    }
}

-- Create note object with timestamp and hash
cast Spell createNote(Silk title, Silk content) -> Relic<Silk, Flux> {
    return {
        "id": generateId(),
        "title": title,
        "content": content,
        "createdAt": time.now(),
        "hash": crypto.sha256(content)
    }
}

-- Get uptime in seconds
cast Spell getUptime() -> Ember {
    let now: Ember = time.timestamp()
    let uptime: Ember = now - startTime
    return uptime
}

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Request Handler
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

cast Spell handler(req, res) {
    requestCount = requestCount + 1
    let method = req.method
    let reqPath = req.pathname
    
    -- Log request with color
    shout(color.cyan("â†’ ") + method + " " + reqPath + color.dimmed(" [#" + requestCount + "]"))
    
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -- GET / - Home page with server info
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    in Stance (reqPath is~ "/") {
        let uptimeSec = getUptime()
        
        return res.html("
            <h1>ğŸ“ FlowLang Notes API</h1>
            <p>Server running on port " + PORT + "</p>
            <p>Uptime: " + uptimeSec + " seconds</p>
            <p>Total requests: " + requestCount + "</p>
            <p>Platform: " + os.name() + " / " + os.arch() + "</p>
            <hr>
            <h3>Endpoints:</h3>
            <ul>
                <li>GET /api/notes - List all notes</li>
                <li>POST /api/notes - Create note (body: {title, content})</li>
                <li>GET /api/info - Server info</li>
                <li>GET /api/stats - Request stats</li>
                <li>GET /api/crypto-demo - Crypto demo</li>
                <li>GET /api/debug - Full request debug</li>
            </ul>
        ")
    }
    
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -- GET /api/notes - List all notes
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    in Stance (method is~ "GET") {
        in Stance (reqPath is~ "/api/notes") {
            return res.json(notes)
        }
    }
    
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -- POST /api/notes - Create a new note
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    in Stance (method is~ "POST") {
        in Stance (reqPath is~ "/api/notes") {
            attempt {
                let body: Relic<Silk, Flux> = json.parse(req.body)
                let title: Silk = body["title"]
                let content: Silk = body["content"]
                
                -- Create note with generated ID and timestamp
                let note = createNote(title, content)
                
                -- Add to array
                notes = arr.push(notes, note)
                
                -- Save to disk
                saveNotes()
                
                shout(color.green("  âœ“ Created note: " + title))
                return res.created(note)
                
            } rescue Rift as e {
                return res.badRequest("Invalid JSON: " + e)
            }
        }
    }
    
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -- GET /api/info - Server info using std:os and std:path
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    in Stance (reqPath is~ "/api/info") {
        let cwd = os.cwd()
        let homeDir = os.home_dir()
        let dataPath = path.resolve(DATA_FILE)
        let parsedPath = path.parse(dataPath)
        
        return res.json({
            "Platform": os.name(),
            "arch": os.arch(),
            "cwd": cwd,
            "homeDir": homeDir,
            "dataFile": {
                "path": dataPath,
                "dir": parsedPath.dir,
                "name": parsedPath.name,
                "ext": parsedPath.ext
            },
            "pathSeparator": path.sep,
            "pid": os.pid()
        })
    }
    
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -- GET /api/stats - Request statistics
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    in Stance (reqPath is~ "/api/stats") {
        let uptimeSec = getUptime()
        let reqPerSec = requestCount / uptimeSec
        
        return res.json({
            "totalRequests": requestCount,
            "uptimeSec": uptimeSec,
            "requestsPerSecond": reqPerSec,
            "notesCount": notes.len(),
            "serverStartTime": startTime
        })
    }
    
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -- GET /api/url-test - URL parsing demo using std:url
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    in Stance (reqPath is~ "/api/url-test") {
        let testUrl = "https://example.com:8080/path/to/resource?name=goku&power=9001"
        let parsed = url.parse(testUrl)
        
        return res.json({
            "originalUrl": testUrl,
            "parsed": parsed,
            "encodedExample": url.encode("hello world!"),
            "decodedExample": url.decode("hello%20world%21")
        })
    }
    
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -- GET /api/crypto-demo - Crypto functions demo
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    in Stance (reqPath is~ "/api/crypto-demo") {
        let text = "FlowLang is awesome!"
        
        return res.json({
            "input": text,
            "md5": crypto.md5(text),
            "sha256": crypto.sha256(text),
            "base64": crypto.base64_encode(text)
        })
    }
    
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -- GET /api/debug - Full request debug
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    in Stance (reqPath is~ "/api/debug") {
        return res.json({
            "method": req.method,
            "pathname": req.pathname,
            "path": req.path,
            "url": req.url,
            "host": req.host,
            "ip": req.ip,
            "protocol": req.protocol,
            "query": req.query,
            "headers": req.headers,
            "cookies": req.cookies,
            "body": req.body
        })
    }
    
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -- 404 - Not Found
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    return res.notFound("Route not found: " + method + " " + reqPath)
}

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Server Startup
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

shout("")
shout(color.bold(color.cyan("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")))
shout(color.bold(color.cyan("  ğŸ“ FlowLang Notes API Server")))
shout(color.bold(color.cyan("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")))
shout("")

-- Show system info
shout(color.dimmed("System: ") + os.name() + " " + os.arch())
shout(color.dimmed("CWD: ") + os.cwd())
shout(color.dimmed("PID: ") + os.pid())
shout("")

-- Load existing notes
loadNotes()

-- Show endpoints
shout("")
shout(color.yellow("ğŸ“¡ Endpoints:"))
shout("   GET  /              â†’ Homepage")
shout("   GET  /api/notes     â†’ List notes")
shout("   POST /api/notes     â†’ Create note")
shout("   GET  /api/info      â†’ Server info (os, path)")
shout("   GET  /api/stats     â†’ Request statistics")
shout("   GET  /api/url-test  â†’ URL parsing demo")
shout("   GET  /api/crypto-demo â†’ Crypto demo")
shout("   GET  /api/debug     â†’ Full request debug")
shout("")

-- Set up periodic stats timer
cast Spell showStats() {
    let uptime = getUptime()
    shout(color.dimmed("ğŸ“Š Stats: " + requestCount + " requests | " + uptime + "s uptime | " + notes.len() + " notes"))
}

-- Show stats every 30 seconds
timer.interval(30000, showStats)

-- Start server
shout(color.green("ğŸš€ Server starting on http://localhost:" + PORT))
shout(color.dimmed("Press Ctrl+C to stop"))
shout("")

web.serve(PORT, handler)
