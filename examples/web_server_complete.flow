-- Complete Web Server Example
-- Demonstrates: std:web, std:url, std:stream, std:json

circle web from "std:web"
circle url from "std:url"
circle stream from "std:stream"
circle json from "std:json"

shout("ğŸš€ FlowLang Web Server")
shout("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
shout("")

-- In-memory data
let users = [
    {"id": 1, "name": "Goku", "power": 9000},
    {"id": 2, "name": "Vegeta", "power": 8500},
    {"id": 3, "name": "Naruto", "power": 7500}
]

-- Request handler
cast Spell handler(req) -> Hollow {
    -- Parse the URL to get query params
    let parsed = url.parse("http://localhost" + req.path)
    let path = parsed.pathname
    let query = parsed.query
    
    shout("ğŸ“¨ " + req.method + " " + path)
    
    -- Simple routing (user handles manually)
    in Stance (path is~ "/") {
        shout("   â†’ Homepage")
    }
    
    in Stance (path is~ "/api/users") {
        shout("   â†’ Users API")
        shout("   â†’ Returning " + users.len() + " users")
    }
    
    in Stance (path is~ "/api/health") {
        shout("   â†’ Health check: OK")
    }
    
    in Stance (path is~ "/test") {
        shout("   â†’ Test endpoint")
        -- Show query params
        shout("   â†’ Query: " + json.stringify(query))
    }
}

-- Start server
shout("ğŸŒ Server: http://localhost:3000")
shout("ğŸ“¡ Endpoints:")
shout("   GET /           - Homepage")
shout("   GET /api/users  - List users")
shout("   GET /api/health - Health check")
shout("   GET /test?id=1  - Test with query")
shout("")
shout("Press Ctrl+C to stop")
shout("")

web.serve(3000, handler)
